<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>TRON å“ˆå¸Œå¤§å°æ¨¡æ‹ŸæŠ•æ³¨æ¸¸æˆ</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  button, input, select { font-size: 16px; margin: 5px 0; }
  #log { background: #f5f5f5; padding: 10px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
</style>
</head>
<body>
<h2>TRON å“ˆå¸Œå¤§å°æ¨¡æ‹ŸæŠ•æ³¨æ¸¸æˆ</h2>

<p>ä½™é¢: <span id="balance">1000</span> TRX</p>

<label>æŠ•æ³¨é‡‘é¢ï¼ˆTRXï¼‰: <input type="number" id="betAmount" value="10" min="1" /></label><br/>

<label>é€‰æ‹©æŠ•æ³¨:
  <select id="betChoice">
    <option value="small">å° (0-4)</option>
    <option value="big">å¤§ (5-9)</option>
  </select>
</label><br/>

<button id="placeBetBtn">ä¸‹æ³¨</button>

<h3>æ¸¸æˆæ—¥å¿—</h3>
<pre id="log"></pre>

<script>
const balanceEl = document.getElementById('balance');
const betAmountInput = document.getElementById('betAmount');
const betChoiceSelect = document.getElementById('betChoice');
const placeBetBtn = document.getElementById('placeBetBtn');
const logEl = document.getElementById('log');

let balance = 1000;   // åˆå§‹ä½™é¢
let currentBet = null; // å½“å‰æŠ•æ³¨å¯¹è±¡ {amount, choice}
let latestBlockNum = null;
const POLL_INTERVAL = 5000; // 5ç§’è½®è¯¢æ–°åŒºå—

const ODDS = 1.95; // èµ”ç‡ï¼Œä¾‹å¦‚çŒœä¸­èµ”1.9å€ï¼ˆå«æœ¬é‡‘ï¼‰

// é€€ä½æ‰¾æ•°å­—ï¼Œåˆ¤æ–­å¤§å°å‡½æ•°
function getJudgingDigit(hash) {
  for(let i = hash.length - 1; i >= 0; i--) {
    const ch = hash[i].toLowerCase();
    if(ch >= '0' && ch <= '9') {
      return parseInt(ch);
    }
  }
  return null;
}

function determineSize(digit) {
  if(digit === null) return null;
  return digit <= 4 ? 'small' : 'big';
}

// æ˜¾ç¤ºæ—¥å¿—
function log(msg) {
  logEl.textContent += msg + '\n';
  logEl.scrollTop = logEl.scrollHeight;
}

// è·å–æœ€æ–°åŒºå—
async function fetchLatestBlock() {
  try {
    const res = await fetch('https://api.trongrid.io/wallet/getnowblock', {method:'POST'});
    const data = await res.json();
    return data;
  } catch(e) {
    log('è·å–æœ€æ–°åŒºå—å¤±è´¥');
    return null;
  }
}

// å¼€å§‹è½®è¯¢æ–°åŒºå—
async function pollNewBlock() {
  const block = await fetchLatestBlock();
  if(!block) return;
  const blockNum = block.block_header.raw_data.number;
  if(latestBlockNum === null) {
    latestBlockNum = blockNum;
    log(`åˆå§‹åŒ–åŒºå—å·ï¼š${blockNum}`);
  } else if(blockNum > latestBlockNum) {
    latestBlockNum = blockNum;
    log(`æ£€æµ‹åˆ°æ–°åŒºå—ï¼š${blockNum}`);
    await settleBet(block);
  }
}

// ç»“ç®—å½“å‰æŠ•æ³¨
async function settleBet(block) {
  if(!currentBet) {
    log(`æ— æŠ•æ³¨ï¼Œè·³è¿‡ç»“ç®—`);
    return;
  }

  const hash = block.blockID;
  const digit = getJudgingDigit(hash);
  if(digit === null) {
    log(`åŒºå—å“ˆå¸Œæœªæ‰¾åˆ°æ•°å­—ï¼Œæ— æ³•åˆ¤å®šå¤§å°ï¼ŒæŠ•æ³¨ä½œåºŸï¼Œè¿”è¿˜æœ¬é‡‘`);
    balance += currentBet.amount;
    updateBalance();
    currentBet = null;
    return;
  }

  const result = determineSize(digit);
  log(`åŒºå—å“ˆå¸Œ: ${hash}`);
  log(`åˆ¤å®šæ•°å­—: ${digit} => å¤§å°: ${result}`);
  log(`ä½ çš„æŠ•æ³¨: ${currentBet.choice}ï¼Œé‡‘é¢: ${currentBet.amount} TRX`);

 if(result === currentBet.choice) {
  // èµ¢ï¼Œèµ¢å¾—æœ¬é‡‘å’Œåˆ©æ¶¦
  const winAmount = currentBet.amount * ODDS;
  balance += winAmount;
  log(`ğŸ‰ æ­å–œä½ èµ¢äº†ï¼è·å¾— ${winAmount.toFixed(2)} TRXï¼ˆå«æœ¬é‡‘ï¼‰`);
} else {
  // è¾“ï¼ŒæŠ•æ³¨é‡‘é¢å·²æ‰£é™¤
  log(`ğŸ˜ å¾ˆé—æ†¾ï¼Œä½ è¾“äº† ${currentBet.amount} TRX`);
}


  updateBalance();
  currentBet = null;
}

// æ›´æ–°ä½™é¢æ˜¾ç¤º
function updateBalance() {
  balanceEl.textContent = balance.toFixed(2);
}

// æŠ•æ³¨äº‹ä»¶
placeBetBtn.onclick = () => {
  if(currentBet) {
    alert('å·²æœ‰æœªç»“ç®—çš„æŠ•æ³¨ï¼Œè¯·ç­‰å¾…å¼€å¥–');
    return;
  }
  let amt = parseFloat(betAmountInput.value);
  if(isNaN(amt) || amt <= 0) {
    alert('è¯·è¾“å…¥æœ‰æ•ˆæŠ•æ³¨é‡‘é¢');
    return;
  }
  if(amt > balance) {
    alert('ä½™é¢ä¸è¶³');
    return;
  }
  const choice = betChoiceSelect.value;
  balance -= amt;
  updateBalance();
  currentBet = {amount: amt, choice};
  log(`ä½ æŠ•æ³¨äº† ${amt} TRXï¼Œé€‰æ‹©äº† ${choice === 'small' ? 'å°(0-4)' : 'å¤§(5-9)'}ï¼Œç­‰å¾…å¼€å¥–...`);
};

// å¯åŠ¨è½®è¯¢
setInterval(pollNewBlock, POLL_INTERVAL);

log('æ¸¸æˆå·²å¯åŠ¨ï¼Œä½™é¢1000 TRXã€‚è¯·ä¸‹æ³¨ï¼');
</script>

</body>
</html>
